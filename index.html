<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Schwimmkurs – Anmeldung</title>
  <style>
    body{font-family:system-ui, sans-serif; max-width:720px; margin:2rem auto; padding:0 1rem}
    .row{margin:.75rem 0} .muted{color:#555} .ok{color:#0a7f2e} .err{color:#b00020}
    button[disabled], option[disabled]{opacity:.6; cursor:not-allowed}
    select, input, button{font-size:1rem; padding:.5rem}
  </style>
</head>
<body>
  <h1>Schwimmkurs – Anmeldung</h1>
  <p class="muted">1) Kurs wählen → 2) Termin wählen → 3) Vor- & Nachname eintragen → 4) Buchen</p>

  <div class="row">
    <label for="course">Kurs</label><br>
    <select id="course"></select>
  </div>

  <div class="row">
    <label for="slot">Termin</label><br>
    <select id="slot"></select>
  </div>

  <div class="row">
    <label for="first">Vorname</label><br>
    <input id="first" type="text" required />
  </div>

  <div class="row">
    <label for="last">Nachname</label><br>
    <input id="last" type="text" required />
  </div>

  <div class="row">
    <button id="bookBtn">Buchen</button>
    <span id="status" class="muted"></span>
  </div>

  <script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbzkNocTapN9nrCqhUgTx8rAMufYTf5bUUMf-DUEs7GHzoakMzEBBEE0eHUctFI26HCV/exec"; // <-- deine Web-App-URL einsetzen

    const elCourse = document.getElementById("course");
    const elSlot   = document.getElementById("slot");
    const elFirst  = document.getElementById("first");
    const elLast   = document.getElementById("last");
    const elBtn    = document.getElementById("bookBtn");
    const elStatus = document.getElementById("status");

    init();

    async function init(){
      elStatus.textContent = "Lade Kurse...";
      try{
        const res = await fetch(`${scriptURL}?fn=courses`);
        const data = await res.json();
        elCourse.innerHTML = "";
        data.courses.forEach(c=>{
          const o=document.createElement("option");
          o.value=c; o.textContent=c;
          elCourse.appendChild(o);
        });
        elStatus.textContent = "";
        await loadSlots();
      }catch(e){
        elStatus.textContent = "Fehler beim Laden der Kurse.";
      }
      elCourse.addEventListener("change", loadSlots);
      elBtn.addEventListener("click", book);
    }

    async function loadSlots(){
      const course = elCourse.value;
      elStatus.textContent = "Lade Termine...";
      elSlot.innerHTML = "";
      try{
        const res = await fetch(`${scriptURL}?fn=slots&course=${encodeURIComponent(course)}`);
        const data = await res.json();
        data.slots.forEach(s=>{
          const o = document.createElement("option");
          // Wir schicken das DE-Datum zurück; Backend normalisiert automatisch.
          o.value = JSON.stringify({date:s.date, time:s.time});
          o.textContent = s.label; // z.B. "18.10.2025 10:45 — frei: 12/16"
          if (s.remaining <= 0) o.disabled = true;
          elSlot.appendChild(o);
        });
        elStatus.textContent = "";
      }catch(e){
        elStatus.textContent = "Fehler beim Laden der Termine.";
      }
    }

    async function book(){
      const first = elFirst.value.trim();
      const last  = elLast.value.trim();
      const course = elCourse.value;
      const slotVal = elSlot.value;

      if (!first){ elStatus.textContent="Bitte Vornamen eingeben."; return; }
      if (!last){  elStatus.textContent="Bitte Nachnamen eingeben."; return; }
      if (!slotVal){ elStatus.textContent="Bitte Termin wählen."; return; }

      const {date, time} = JSON.parse(slotVal); // date = "TT.MM.JJJJ", time = "HH:MM"

      elBtn.disabled = true;
      elStatus.textContent = "Buchen...";

      try{
        // Kein Content-Type setzen -> Browser sendet text/plain -> kein CORS-Preflight
        const res = await fetch(scriptURL, {
          method: "POST",
          body: JSON.stringify({ firstName:first, lastName:last, course, date, time })
        });
        const data = await res.json().catch(()=>({}));

        if (res.ok && data.ok){
          elStatus.className = "ok";
          elStatus.textContent = "✅ Eingetragen!";
          await loadSlots(); // Restplätze aktualisieren
        }else{
          elStatus.className = "err";
          const err = (data && data.error) || "ERROR";
          elStatus.textContent = ({
            ALREADY_BOOKED: "Diese Person ist für diesen Termin bereits eingetragen.",
            SLOT_FULL:      "Termin ist leider voll.",
            UNKNOWN_SLOT:   "Unbekannter Termin.",
            FIELDS_MISSING: "Bitte alle Felder ausfüllen."
          })[err] || "Fehler bei der Buchung.";
        }
      }catch(e){
        elStatus.className = "err";
        elStatus.textContent = "Netzwerkfehler.";
      }finally{
        elBtn.disabled = false;
      }
    }
  </script>
</body>
</html>
